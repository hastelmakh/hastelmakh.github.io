description: 'Setup PHP and Composer dependencies with cache'
inputs:
  version:
    description: 'PHP version to setup'
    required: true
  extensions:
    description: 'PHP extensions to setup (comma + space separated)'
    required: true

runs:
  using: 'composite'
  steps:
    - name: 'Prepare vars'
      id: vars
      shell: bash
      run: |
        {
          echo "composer_cache_paths<<EOF"
            echo "$(composer config cache-files-dir)"
          echo "EOF"
        } >> "$GITHUB_OUTPUT"
        
        COMPOSER_LOCK_HASH="${{ hashFiles('composer.lock') }}"
        echo "composer_cache_key=composer-${COMPOSER_LOCK_HASH}" >> $GITHUB_OUTPUT
        
        {
          echo "composer_cache_restore_keys<<EOF"
            echo "composer-${COMPOSER_LOCK_HASH}"
            echo "composer-"
          echo "EOF"
        } >> "$GITHUB_OUTPUT"

    - name: 'Setup PHP'
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ inputs.version }}
        extensions: ${{ inputs.extensions }}
        coverage: xdebug

    - name: 'Validate composer.json and composer.lock'
      shell: bash
      run: composer validate

    - name: 'Restore Composer cache'
      id: composer_cache
      uses: actions/cache/restore@v5
      with:
        path: ${{ steps.vars.outputs.composer_cache_paths }}
        key: ${{ steps.vars.outputs.composer_cache_key }}
        restore-keys: ${{ steps.vars.outputs.composer_cache_restore_keys }}

    - name: 'Install Composer dependencies'
      shell: bash
      run: composer install --prefer-dist --no-progress --no-interaction

    - name: 'Persist Composer cache'
      if: steps.composer_cache.outputs.cache-hit != 'true'
      uses: actions/cache/save@v5
      with:
        path: ${{ steps.vars.outputs.composer_cache_paths }}
        key: ${{ steps.vars.outputs.composer_cache_key }}
